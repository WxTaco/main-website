name: Sync main-website to monorepo

on:
  push:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: sync-to-monorepo-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-to-monorepo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main-website
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          repository: WxTaco/wrapped
          token: ${{ secrets.MONOREPO_TOKEN }}
          path: wrapped
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync website into monorepo
        run: |
          set -euo pipefail
          mkdir -p ./wrapped/main-web
          rsync -a --delete --exclude='.git/' ./ ./wrapped/main-web/

      - name: Commit and push changes if any
        run: |
          cd wrapped
          git add -A
          if ! git diff-index --quiet HEAD; then
            git commit -m "Sync main-website changes into monorepo (main-web/)"
            git push -q origin HEAD:sync/main-website-to-monorepo --force
          else
            echo "No changes to commit"
          fi

      - name: Create or update Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MONOREPO_TOKEN }}
          path: wrapped
          branch: sync/main-website-to-monorepo
          title: "Sync main-website changes into monorepo"
          commit-message: "Sync main-website changes into monorepo (main-web/)"
          body: |
            This PR syncs the latest changes from **WxTaco/main-website** into the `main-web/` folder of **WxTaco/wrapped**.

            - Source repo: WxTaco/main-website
            - Target folder: `main-web/`

            Triggered automatically by GitHub Actions.
          labels: sync, automated
          update-existing: true      - name: Sync website into monorepo
        run: |
          set -euo pipefail
          mkdir -p ./wrapped/main-web
          rsync -a --delete --exclude='.git/' ./ ./wrapped/main-web/ >/dev/null

      - name: Commit changes
        run: |
          cd wrapped
          git add -A
          if ! git diff-index --quiet HEAD; then
            git commit -m "Sync main-website changes into monorepo (main-web/)"
          else
            echo "No changes to commit"

      - name: Push to sync branch
        run: |
          cd wrapped
          git push -q origin HEAD:sync/main-website-to-monorepo --force

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MONOREPO_TOKEN }}
          path: wrapped
          branch: sync/main-website-to-monorepo
          title: "Sync main-website changes into monorepo"
          commit-message: "Sync main-website changes into monorepo (main-web/)"
          body: |
            This PR syncs the latest changes from **WxTaco/main-website** into the `main-web/` folder of **WxTaco/wrapped**.

            - Source repo: WxTaco/main-website
            - Target folder: `main-web/`

            Triggered automatically by GitHub Actions.
          labels: sync, automated
