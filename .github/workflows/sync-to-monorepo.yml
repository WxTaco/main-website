name: Sync main-website to monorepo

on:
  push:
    branches: [ main ]

permissions:
  contents: read

concurrency:
  group: sync-to-monorepo-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-to-monorepo:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout main-website repo
      - name: Checkout main-website
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for full commit history for subtree

      # 2️⃣ Checkout monorepo into separate folder
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          repository: WxTaco/wrapped
          token: ${{ secrets.MONOREPO_TOKEN }}
          path: wrapped
          fetch-depth: 0

      # 3️⃣ Configure git for automated commits
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 4️⃣ Create a subtree branch from main-website
      - name: Create subtree branch (log-safe)
        run: |
          # Use quiet mode to avoid printing files
          git subtree split --prefix=. -b main-web-branch -q

      # 5️⃣ Push subtree branch into monorepo branch
      - name: Push subtree to monorepo
        run: |
          cd wrapped
          git remote add main-website-temp ../
          git fetch -q main-website-temp main-web-branch

          # Merge into main-web folder quietly
          git subtree add --prefix=main-web main-website-temp/main-web-branch --squash -q || \
            git subtree merge --prefix=main-web main-website-temp/main-web-branch --squash -q

          # Push to sync branch in monorepo quietly
          git push -q origin HEAD:sync/main-website-to-monorepo --force

      # 6️⃣ Create or update Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MONOREPO_TOKEN }}
          path: wrapped
          branch: sync/main-website-to-monorepo
          title: "Sync main-website changes into monorepo"
          commit-message: "Sync main-website changes into monorepo (main-web/)"
          body: |
            This PR syncs the latest changes from **WxTaco/main-website** into the `main-web/` folder of **WxTaco/wrapped**.

            - Source repo: WxTaco/main-website
            - Target folder: `main-web/`
            - Preserves commit history from main-website

            Triggered automatically by GitHub Actions.
          labels: sync, automated
